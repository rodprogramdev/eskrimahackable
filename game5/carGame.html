<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAR RACING</title>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            margin: 0;
        }

        .canvas {
            height: 110vh;
            background-color: rgb(60, 110, 51);
            display: block;
            text-align: center;

            color: black;
            padding-top: 1%;
            border: 10px solid black;
        }

        h1 {
            color: #fff;
            font-size: 1rem;
        }

        p {
            color: #fff;
            font-size: 3px;
        }

        #hash{
            color:black;
            text-align:center;
            
        }
    </style>
</head>

<body>


    <div class="canvas">
        <h1>TRACK GAME</h1>
        <canvas id="gameCanvas" height="600" width="800">
            <!-- height="500" width="900"-->
           
        </canvas>
        <!-- <p id="hash">482c811da5d5b4bc6d497ffa98491e38</p>  -->
    </div>

    <script>

        var carPic = document.createElement("img");
        var carPicLoaded = false;

        /******************************VARIABLES FOR CANVAS******************************************/
        var canvas, canvasContext; 



        const KEY_LEFT_ARROW = 65; //keyboard A
        const KEY_UP_ARROW = 87; // keyboard W
        const KEY_RIGHT_ARROW =68 ;//keyboard D
        const KEY_DOWN_ARROW = 83;// keyboard S

        var keyHeld_Gas = false;
        var keyHeld_Reverse = false;
        var keyHeld_TurnLeft = false;
        var keyHeld_TurnRight = false;

        /******************************VARIABLES FOR CAR******************************************/
        var mouseX = 0;
        var mouseY = 0;
        var carX = 75; //We will use this value in our arcMethod x axis
        var carY = 75;
       // var carSpeedX = 5;
         //var carSpeedY = 7;

        /******************************ROTATIONAL VARIABLES FOR CAR******************************************/
       var carAng = 0;

       var carSpeed =0;

        /******************************VARIABLES ******************************************/
       

        const TRACK_W = 40;
        const TRACK_H = 40; 
        const TRACK_GAP = 2;
        const TRACK_COLS = 20;
        const TRACK_ROWS = 15; 

        const GROUNDSPEED_DECAY_MULT = 0.94;
        const DRIVE_POWER = 0.5;
        const REVERSE_POWER = 0.2;
        const TURN_RATE = 0.03;


        var trackGrid = [ 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,  
                          1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,
                          1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,
                          1,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,1,
                          1,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,1,
                          1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1,  
                          1,0,0,1,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,1,
                          1,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,1,0,0,1,
                          1,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,1,
                          1,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,1,0,0,1,
                          1,0,0,1,1,1,1,1,0,0,0,0,0,0,0,1,1,0,0,1,  
                          1,0,0,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,
                          1,0,2,1,1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,
                          1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
                          1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,  
                         
                            ];
        // var trackGrid = new Array(TRACK_COLS * TRACK_ROWS);
        // var tracksLeft = 0;



        /*****************************FUNCTION TO UPDATE THE MOUSE POSITION**********************************************/


        function updateMousePosition(mouseEvent) {
            var rect = canvas.getBoundingClientRect(); 
            var root = document.documentElement; 
            mouseX = mouseEvent.clientX - rect.left - root.scrollLeft; // this will grab the clientX which is what we call t
            mouseY = mouseEvent.clientY - rect.top - root.scrollTop; // we don't need the mouse Y but we might need this value some other time so we put it here. 

           

            //Cheat to test car in any position;
            // carX = mouseX;
            // carY = mouseY;
            // carSpeedX = 4;
            // carSpeedY = -4;

        }

       
        /******************************FUNCTION DECLARATION WHEN THE WINDOWS LOAD******************************************/

        function keyPressed(evt){
            //console.log("Key pressed:"+evt.keyCode);
            if(evt.keyCode == KEY_LEFT_ARROW){
                // carAng -= 0.5;
                keyHeld_TurnLeft = true;

            }
            if(evt.keyCode == KEY_RIGHT_ARROW){
                
                // carAng += 0.5;
                keyHeld_TurnRight = true;
            }

            if(evt.keyCode ==KEY_UP_ARROW){
                console.log("Key pressed:"+ evt.keyCode);
                // carSpeed += 0.5;
                keyHeld_Gas = true;
            }
            if(evt.keyCode == KEY_DOWN_ARROW){
                // carAng -= 0.5;
                 keyHeld_Reverse = true;
            }
        }

        function keyReleased(evt){
            // console.log("Key release:"+evt.keyCode);
            if(evt.keyCode == KEY_LEFT_ARROW){
                // carAng -= 0.5;
                keyHeld_TurnLeft = false;

            }
            if(evt.keyCode == KEY_RIGHT_ARROW){
                // carAng += 0.5;
                keyHeld_TurnRight = false;
            }

            if(evt.keyCode ==KEY_UP_ARROW){
                // carSpeed += 0.5;
                keyHeld_Gas = false;
            }
            if(evt.keyCode == KEY_DOWN_ARROW){
                // carAng -= 0.5;
                 keyHeld_Reverse = false;
            }
        }

        // const KEY_LEFT_ARROW = 65; //keyboard A
        // const KEY_UP_ARROW = 87; // keyboard W
        // const KEY_RIGHT_ARROW =68 ;//keyboard D
        // const KEY_DOWN_ARROW = 83;// keyboard S

        // var keyHeld_Gas = false;
        // var keyHeld_reverse = false;
        // var keyHeld_TurnLeft = false;
        // var keyHeld_TurnRight = false;

        window.onload = function () {
            canvas = document.getElementById('gameCanvas');
            canvasContext = canvas.getContext('2d');
            var framesPersecond = 30;
            setInterval(updateAll, 1000 / framesPersecond);
            canvas.addEventListener('mousemove', updateMousePosition);
            carPic.onload = function(){
                carPicLoaded = true;
            }
            document.addEventListener('keydown',keyPressed);
            document.addEventListener('keyup',keyReleased);


            carPic.src = "../images/car.png";
            carReset();
        }


        /******************************FUNCTION DECLARATION FOR UPDATING THE MOVEMENT OF THE CAR******************************************/

        function updateAll() {
            moveAll();
            drawAll();
        }

        /****************************FUNCTION CAR RESET*************************************************/
       
        function carReset() {
            for (var eachRow = 0; eachRow < TRACK_ROWS; eachRow++) {
                for (var eachCol = 0; eachCol < TRACK_COLS; eachCol++) {
                    var arrayIndex = rowColToArrayIndex(eachCol, eachRow);
                    if (trackGrid[arrayIndex] == 2) {
                        trackGrid[arrayIndex] = 0;
                        // carAng = -90 * Math.PI/180.0; //Multiply * radiance math.pi
                        carAng = -Math.PI/2;
                        carX = eachCol * TRACK_W;
                        carY = eachRow * TRACK_H;
                    }
                }
            }
          
        }




        /****************************FUNCTION CAR MOVE*************************************************/
        //Lets look at the code in the moveAll function on when does the car hit the bottom of the screen. 
        function carMove() {
            carSpeed *= GROUNDSPEED_DECAY_MULT;
            if(keyHeld_Gas){
                carSpeed += DRIVE_POWER;
            }
            if (keyHeld_Reverse){
                carSpeed -= REVERSE_POWER;

            }
            if(keyHeld_TurnLeft){
                carAng -= TURN_RATE;

            }
            if(keyHeld_TurnRight){
                carAng += TURN_RATE;
            }

            carX += Math.cos(carAng) * carSpeed;
            carY += Math.sin(carAng) * carSpeed;
            // carAng += 0.02; Makes the car spin
            
       

        }
        /****************************HELPER FUNCTION TO DO BALANCE CHECK*************************************/
        function isTrackAtColRow(col,row){
            if(col >=  0 && col < TRACK_COLS &&
                row >= 0 && row < TRACK_ROWS){
                    var trackIndexUnderCoord = rowColToArrayIndex(col,row);
                    return (trackGrid[trackIndexUnderCoord] == 1);
                }else{
                    return false;
                }
            
        }

        /****************************FUNCTION TRACK HANDLING*************************************************/

        function carTrackHandling() {

            var carTrackCol = Math.floor(carX / TRACK_W);
            var carTrackRow = Math.floor(carY / TRACK_H);
            var trackIndexUnderCar = rowColToArrayIndex(carTrackCol, carTrackRow);

            if (carTrackCol >= 0 && carTrackCol < TRACK_COLS &&
                carTrackRow >= 0 && carTrackRow < TRACK_ROWS) {

                if (isTrackAtColRow(carTrackCol,carTrackRow)) {
                    carX -= Math.cos(carAng) * carSpeed;
            carY -= Math.sin(carAng) * carSpeed;
            // carAng += 0.02; Makes the car spin
             
                  carSpeed *= -0.5;
                  
                }// end of track found

            }// end of valid col and row

        }// end of carTrackHandling function


        function moveAll() {
            carMove();
            carTrackHandling();
           
        }


        function rowColToArrayIndex(col, row) {
            return col + TRACK_COLS * row;

        }
        /******************************GENERAL FUNCTION DECLARATION FOR DRAWING ON THE CANVASS******************************************/

        function drawAll() {
            colorRect(0, 0, canvas.width, canvas.height, 'black'); // This will clear the screen
            // colorCircle(carX, carY, 10, 'white'); // This will draw the circle  

            if(carPicLoaded){
                drawBitmapCenteredWithRotation(carPic, carX, carY,carAng) ;
            }

            /************DRAW TRACKS***************/
       
            drawTracks();
            /**********MOUSE POSITION**************/

        }



        function drawBitmapCenteredWithRotation(useBitmap,atX,atY,withAng){
            canvasContext.save();
            canvasContext.translate(atX,atY);
            canvasContext.rotate(withAng);
            canvasContext.drawImage(useBitmap,-useBitmap.width/2,-useBitmap.height/2);
            canvasContext.restore();
        }

        function drawTracks() {
            for (var eachRow = 0; eachRow < TRACK_ROWS; eachRow++) {
                for (var eachCol = 0; eachCol < TRACK_COLS; eachCol++) {

                    var arrayIndex = rowColToArrayIndex(eachCol, eachRow);

                    if (trackGrid[arrayIndex] == 1) {
                        colorRect(TRACK_W * eachCol, TRACK_H * eachRow,
                            TRACK_W - TRACK_GAP, TRACK_H - TRACK_GAP, 'brown');
                    } //end of is this track here
                } // end of for each track      
            }
        }//end of drawTracks()

      

        /******************************FUNCTION DECLARATION WHEN THE WINDOWS LOAD******************************************/


        function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor) {
            canvasContext.fillStyle = fillColor;
            canvasContext.fillRect(topLeftX, topLeftY, boxWidth, boxHeight);
        }

        function colorCircle(centerX, centerY, radius, fillColor) {
            canvasContext.fillStyle = fillColor;
            canvasContext.beginPath(); //hover functions 
            canvasContext.arc(centerX, centerY, radius, 0, Math.PI * 2, true); // this will work because the Math.PI * 2 will never change  nor the other lines and this is just simplifying things for us.  
            canvasContext.fill();

        }

        function colorText(showWords, textX, textY, fillColor) {
            canvasContext.fillStyle = fillColor;
            canvasContext.fillText(showWords, textX, textY);

        }

      


    </script>
    
</body>

</html>